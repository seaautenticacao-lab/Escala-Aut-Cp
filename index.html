<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Management | Wide Precision v32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        
        :root[data-theme="dark"] {
            --accent: #818cf8; --bg: #020617; --card: #0f172a; --text: #f8fafc;
            --border: #475569; --name-bg: #1e293b; --slot-bg: #334155; --table-border: #475569;
        }
        :root[data-theme="light"] {
            --accent: #4338ca; --bg: #f8fafc; --card: #ffffff; --text: #000000;
            --border: #1e293b; --name-bg: #e2e8f0; --slot-bg: #cbd5e1; --table-border: #000000;
        }

        body { 
            background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; 
            font-weight: 900; transition: 0.3s; 
            user-select: none; -webkit-user-drag: none;
            margin: 0; padding: 20px;
        }
        
        .sidebar-nav { background: var(--card); border-radius: 20px; padding: 8px; display: flex; gap: 8px; margin: 0 auto 20px; width: fit-content; border: 2px solid var(--border); }
        .nav-btn { border: none; background: transparent; color: var(--text); padding: 10px 20px; border-radius: 15px; font-weight: 900; cursor: pointer; }
        .nav-btn.active { background: var(--accent); color: #fff !important; }
        
        .paint-palette { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 3px solid var(--border); width: 100%; }
        .glass-card { background: var(--card); border-radius: 15px; border: 3px solid var(--border); padding: 20px; width: 100%; margin-bottom: 30px; position: relative; overflow-x: auto; }

        .table-modern { width: 100%; border-collapse: separate; border-spacing: 0; }
        .table-modern th { text-align: center; font-size: 0.75rem; color: var(--text); padding: 8px 2px; border-bottom: 3px solid var(--table-border); border-right: 1px solid var(--border); min-width: 38px; }
        .td-name { background: var(--name-bg); color: var(--text); border: 2px solid var(--table-border) !important; padding: 10px; min-width: 200px; position: sticky; left: 0; z-index: 10; }
        
        .slot { 
            width: 100%; min-width: 40px; height: 40px; 
            border-radius: 6px; background: var(--slot-bg); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.75rem; font-weight: 900; cursor: crosshair; 
            border: 1px solid var(--table-border); 
        }

        /* Cores Mantidas Exatamente */
        .st-9H, .st-14H { background: #0044ff !important; color: white !important; }
        .st-8H, .st-13H { background: #00e676 !important; color: #000 !important; } 
        .st-11H { background: #00e5ff !important; color: #000 !important; }        
        .st-0-5 { background: #ffffff !important; color: #000 !important; border: 2px solid #000 !important; }
        .st-F { background: #ff1744 !important; color: white !important; }           
        .st-BH-1, .st-BH-05 { background: #d500f9 !important; color: white !important; } 
        .st-FF { background: #475569 !important; color: white !important; }
        .st-FD { background: #ff6d00 !important; color: white !important; }           
        .st-FE { background: #ffea00 !important; color: #000 !important; }            
        .st-FER { background: #166534 !important; color: white !important; }

        .tools-wrapper { display: flex; align-items: center; justify-content: center; gap: 5px; flex-wrap: wrap; padding-top: 15px; border-top: 2px solid var(--border); }
        .paint-tool { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; color: white !important; border: 2px solid rgba(0,0,0,0.2); }
        .paint-tool.active { outline: 4px solid var(--text); transform: scale(1.1); }

        .btn-capture { background: #10b981; color: white; border: 2px solid #000; padding: 6px 15px; border-radius: 8px; font-weight: 900; }
        .capturing .btn-del-row, .capturing .btn-capture, .capturing .btn-add-row { display: none !important; }
    </style>
</head>
<body>

    <div class="sidebar-nav">
        <button class="nav-btn active" onclick="setTab('autenticacao', this)">CP GERAL</button>
        <button class="nav-btn" onclick="setTab('sabado', this)">Sábados</button>
        <button class="nav-btn" onclick="setTab('domingo', this)">Domingos</button>
    </div>

    <div class="paint-palette">
        <div class="d-flex flex-column align-items-center">
            <div class="d-flex gap-2 align-items-center mb-3 flex-wrap justify-content-center">
                <select id="sel-mes" class="form-select border-dark fw-bold" style="width:150px" onchange="render()"></select>
                <select id="sel-ano" class="form-select border-dark fw-bold" style="width:110px" onchange="render()"></select>
                <button class="btn btn-dark fw-bold" onclick="toggleTheme()"><i class="fas fa-adjust"></i> TEMA</button>
                <button class="btn btn-success fw-bold" onclick="save()"><i class="fas fa-save"></i> SALVAR</button>
                <button class="btn btn-primary fw-bold" onclick="changeBox(1)"><i class="fas fa-plus"></i> ADICIONAR MÊS</button>
            </div>

            <div class="tools-wrapper">
                <div class="paint-tool st-9H" onclick="selectTool('9H', this)">9H</div>
                <div class="paint-tool st-8H" onclick="selectTool('8H', this)">8H</div>
                <div class="paint-tool st-11H" onclick="selectTool('11H', this)">11H</div>
                <div class="paint-tool st-13H" onclick="selectTool('13H', this)">13H</div>
                <div class="paint-tool st-14H" onclick="selectTool('14H', this)">14H</div>
                <div class="paint-tool st-0-5" onclick="selectTool('0.5', this)">0,5</div>
                <div class="paint-tool st-F" onclick="selectTool('F', this)">F</div>
                <div class="paint-tool st-FER" onclick="selectTool('FER', this)">FER</div>
                <div class="paint-tool st-BH-1" onclick="selectTool('BH-1', this)">BH-1</div>
                <div class="paint-tool st-BH-05" onclick="selectTool('BH-0.5', this)">BH-0.5</div>
                <div class="paint-tool st-FF" onclick="selectTool('FF', this)">FF</div>
                <div class="paint-tool st-FD" onclick="selectTool('FD', this)">FD</div>
                <div class="paint-tool st-FE" onclick="selectTool('FE', this)">FE</div>
                <div class="paint-tool bg-dark ms-2" onclick="selectTool('', this)"><i class="fas fa-eraser"></i></div>
                <button class="btn btn-outline-primary ms-3 fw-bold border-2" onclick="modalNomes.show()">EQUIPE</button>
            </div>
        </div>
    </div>

    <div id="render-zone"></div>

    <div class="modal fade" id="modalNomes" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content glass-card"><div class="modal-body">
        <h5 class="fw-900">Equipe</h5>
        <div class="input-group my-3"><input id="inNome" class="form-control border-dark" placeholder="Nome..."><button class="btn btn-primary" onclick="addN()">ADD</button></div>
        <div id="listN" class="list-group"></div>
    </div></div></div></div>

    <div class="modal fade" id="modalAdd" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content glass-card"><div class="modal-body">
        <h6 class="fw-900 text-center">Adicionar Técnico</h6>
        <select id="selT" class="form-select mb-3 border-dark"></select>
        <div id="extra-fields" style="display:none">
            <select id="selS" class="form-select mb-3 border-dark"><option value="1">Semana 1</option><option value="2">Semana 2</option><option value="3">Semana 3</option><option value="4">Semana 4</option><option value="5">Semana 5</option></select>
        </div>
        <input type="hidden" id="targetMonth"><input type="hidden" id="targetYear">
        <button class="btn btn-primary w-100 fw-900" onclick="confirmAdd()">ADICIONAR</button>
    </div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = { k: '$2a$10$Q2kXyLLkTCC5B3yZji9a3.DpwGfIxqoCxivdXlEX95CSREglkI/xG', b: '696fe1e1ae596e708fe97dbb' };
        let db = { escalas: {}, nomesLista: [], config: { boxCount: 1 } };
        let curTab = 'autenticacao', selectedTool = null;

        const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
        const modalNomes = new bootstrap.Modal(document.getElementById('modalNomes'));
        const modalAdd = new bootstrap.Modal(document.getElementById('modalAdd'));
        
        const mesSel = document.getElementById('sel-mes');
        const anoSel = document.getElementById('sel-ano');
        meses.forEach((m, i) => mesSel.innerHTML += `<option value="${i}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`);
        for(let a=2024; a<=2026; a++) anoSel.innerHTML += `<option value="${a}" ${a === new Date().getFullYear() ? 'selected' : ''}>${a}</option>`;

        function getMonthKey(m, a) { return `${m}-${a}`; }
        function getEscala(m, a, tab) { 
            const key = getMonthKey(m, a);
            if(!db.escalas[key]) db.escalas[key] = { autenticacao: [], sabado: [], domingo: [] };
            return db.escalas[key][tab] || [];
        }

        async function save() {
            try { await fetch(`https://api.jsonbin.io/v3/b/${API.b}`, { method: 'PUT', headers: { "Content-Type": "application/json", "X-Master-Key": API.k }, body: JSON.stringify(db) }); alert("Salvo!"); } catch (e) { alert("Erro!"); }
        }

        async function load() {
            try { const r = await fetch(`https://api.jsonbin.io/v3/b/${API.b}/latest`, { headers: { "X-Master-Key": API.k, "X-Bin-Meta": "false" }}); db = await r.json(); render(); } catch (e) { console.error("Erro load"); }
        }

        function downloadPNG(id, name) {
            const el = document.getElementById(id);
            el.classList.add('capturing');
            setTimeout(() => {
                html2canvas(el, { scale: 3, useCORS: true, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card').trim() }).then(canvas => {
                    const link = document.createElement('a'); link.download = `Escala_${name}.png`; link.href = canvas.toDataURL("image/png", 1.0); link.click();
                    el.classList.remove('capturing');
                });
            }, 100);
        }

        function toggleTheme() {
            const html = document.documentElement;
            html.setAttribute('data-theme', html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
            render();
        }

        function render() {
            const area = document.getElementById('render-zone');
            const mB = parseInt(mesSel.value); const aB = parseInt(anoSel.value);
            let h = "";
            const count = db.config?.boxCount || 1;

            for(let b=0; b < count; b++) {
                let cM = (mB + b) % 12; let cA = aB + Math.floor((mB + b) / 12);
                let dim = new Date(cA, cM + 1, 0).getDate();
                let boxID = `box-${b}`;
                const items = getEscala(cM, cA, curTab);

                let head = `<th class="td-name">TÉCNICO</th>` + Array.from({length: dim}, (_, i) => i + 1).map(d => {
                    let dName = ['DOM','SEG','TER','QUA','QUI','SEX','SAB'][new Date(cA, cM, d).getDay()];
                    return `<th style="${dName==='DOM'?'color:#ff4444':''}">${d}<br>${dName}</th>`;
                }).join('');

                let rows = items.map((item, idx) => {
                    let r = `<td class="td-name"><i class="fas fa-trash btn-del-row text-danger me-2" style="cursor:pointer" onclick="delE(${cM}, ${cA}, ${idx})"></i>${item.nome}</td>`;
                    for(let d=1; d<=dim; d++){
                        let val = item.dias?.[d] || '';
                        let isFF = val.toString().startsWith('FF:');
                        let disp = isFF ? val.split(':')[1] : val;
                        let cls = isFF ? 'FF' : val.toString().replace('.','-');
                        r += `<td><div class="slot st-${cls||'vazio'}" onmousedown="handlePaint(event, ${cM}, ${cA}, ${idx}, ${d})" onmouseenter="handlePaint(event, ${cM}, ${cA}, ${idx}, ${d})">${disp}</div></td>`;
                    }
                    return `<tr>${r}</tr>`;
                }).join('');

                h += `<div class="glass-card" id="${boxID}"><div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="m-0 fw-900 text-uppercase" style="color:var(--accent)">${meses[cM]} ${cA} - ${curTab}</h4>
                    <div class="d-flex gap-2"><button class="btn btn-sm btn-dark btn-add-row border-secondary" onclick="openAdd(${cM}, ${cA})"><i class="fas fa-plus"></i> TÉCNICO</button>
                    <button class="btn-capture" onclick="downloadPNG('${boxID}', '${meses[cM]}_${cA}')"><i class="fas fa-camera"></i> BAIXAR PNG</button></div></div>
                    <table class="table-modern"><thead><tr>${head}</tr></thead><tbody>${rows}</tbody></table></div>`;
            }
            area.innerHTML = h;
            document.getElementById('listN').innerHTML = (db.nomesLista || []).map((n, i) => `<div class="list-group-item d-flex justify-content-between"><span>${n}</span> <i class="fas fa-trash text-danger" onclick="delN(${i})"></i></div>`).join('');
            document.getElementById('selT').innerHTML = (db.nomesLista || []).map(n => `<option>${n}</option>`).join('');
        }

        // LÓGICA DE CLIQUE E ARRASTE REFINADA
        function selectTool(v, el) { selectedTool = v; document.querySelectorAll('.paint-tool').forEach(t => t.classList.remove('active')); if(el) el.classList.add('active'); }

        function handlePaint(e, m, a, idx, d) {
            // event.buttons === 1 garante que a pintura SÓ ocorra se o botão esquerdo estiver pressionado
            if (e.buttons !== 1 || selectedTool === null) return;

            const items = getEscala(m, a, curTab);
            if (!items[idx].dias) items[idx].dias = {};

            let finalValue = selectedTool;

            if (selectedTool === 'FF') {
                if (e.type === 'mousedown') {
                    let n = prompt("Feriado:");
                    finalValue = n ? "FF:" + n : "FF";
                } else { return; } // Não arrasta Feriado para evitar múltiplos prompts
            }

            items[idx].dias[d] = finalValue;
            
            // Atualização visual imediata
            const cell = e.target;
            const cls = finalValue.toString().startsWith('FF:') ? 'FF' : finalValue.toString().replace('.','-');
            cell.className = `slot st-${cls || 'vazio'}`;
            cell.innerText = finalValue.toString().includes(':') ? finalValue.split(':')[1] : finalValue;
        }

        function openAdd(m, a) { document.getElementById('targetMonth').value = m; document.getElementById('targetYear').value = a; modalAdd.show(); }
        function confirmAdd() {
            const m = document.getElementById('targetMonth').value; const a = document.getElementById('targetYear').value;
            const n = document.getElementById('selT').value; const key = getMonthKey(m, a);
            db.escalas[key][curTab].push({ nome: n, semana: document.getElementById('selS').value, dias: {} });
            render(); modalAdd.hide();
        }

        function changeBox(v) { db.config.boxCount = Math.max(1, (db.config.boxCount||1) + v); render(); }
        function addN() { const i = document.getElementById('inNome'); if(i.value) { db.nomesLista.push(i.value); i.value=''; render(); } }
        function delN(i) { db.nomesLista.splice(i,1); render(); }
        function delE(m, a, idx) { db.escalas[getMonthKey(m,a)][curTab].splice(idx,1); render(); }
        function setTab(t, b) { curTab = t; document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); render(); }

        window.onload = load;
    </script>
</body>
</html>
