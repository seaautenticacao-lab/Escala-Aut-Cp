<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Management | CP GERAL Crystal Clear</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        
        :root[data-theme="light"] {
            --accent: #4338ca;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #000000;
            --border: #64748b;
            --sub-text: #334155;
            --name-bg: #e2e8f0;
            --slot-bg: #cbd5e1;
        }

        :root[data-theme="dark"] {
            --accent: #6366f1;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #ffffff;
            --border: #475569;
            --sub-text: #94a3b8;
            --name-bg: #334155;
            --slot-bg: #0f172a;
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Outfit', sans-serif; 
            font-weight: 900; 
            transition: 0.3s; 
            user-select: none;
            -webkit-user-drag: none;
        }
        
        .sync-indicator { position: fixed; top: 20px; left: 20px; font-size: 0.8rem; font-weight: 900; display: flex; align-items: center; gap: 8px; background: var(--card); padding: 10px 18px; border-radius: 50px; z-index: 1000; border: 2px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .pulse-dot { width: 10px; height: 10px; background: #00c853; border-radius: 50%; }

        .sidebar-nav { background: var(--card); border-radius: 20px; padding: 8px; display: flex; gap: 8px; margin: 20px auto; width: fit-content; border: 2px solid var(--border); }
        .nav-btn { border: none; background: transparent; color: var(--text); padding: 12px 24px; border-radius: 15px; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        .nav-btn.active { background: var(--accent); color: #fff !important; }
        
        .paint-palette { background: var(--card); padding: 25px; border-radius: 25px; margin: 0 auto 25px; max-width: 1250px; border: 3px solid var(--border); }
        .mes-badge { background: var(--accent); color: #fff; padding: 10px 25px; border-radius: 50px; font-weight: 900; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border: 2px solid #000; }
        
        .mes-select-transparent { background: rgba(0,0,0,0.1); border: 1px solid #fff; color: white; font-weight: 900; cursor: pointer; outline: none; border-radius: 8px; padding: 2px 5px; }
        .mes-select-transparent option { color: #000; }
        
        .btn-box { background: #334155; color: white; border: 2px solid #000; padding: 8px 20px; border-radius: 12px; font-weight: 900; margin: 0 5px; cursor: pointer; }

        .tools-wrapper { display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap; padding-top: 15px; border-top: 3px solid var(--border); }
        .paint-tool { min-width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.85rem; font-weight: 900; color: white !important; border: 2px solid rgba(0,0,0,0.2); }
        .paint-tool.active { outline: 4px solid #000; transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.3); }

        .st-9H, .st-14H { background: #0044ff !important; color: white !important; }
        .st-8H, .st-13H { background: #00c853 !important; color: #000 !important; } 
        .st-11H { background: #00e5ff !important; color: #000 !important; }        
        .st-0-5 { background: #ffffff !important; color: #000 !important; border: 2px solid #000 !important; }
        .st-F { background: #ff1744 !important; color: white !important; }            
        .st-BH-1, .st-BH-05 { background: #d500f9 !important; color: white !important; } 
        .st-FF { background: #455a64 !important; color: white !important; }
        .st-FD { background: #ff6d00 !important; color: white !important; }            
        .st-FE { background: #ffd600 !important; color: #000 !important; border: 1px solid #000; }            
        .st-FER { background: #1b5e20 !important; color: white !important; }
        
        .glass-card { background: var(--card); border-radius: 25px; border: 3px solid var(--border); padding: 25px; width: fit-content; margin: 0 auto 30px auto; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .table-title { font-weight: 900; font-size: 1.4rem; color: var(--accent); margin-bottom: 20px; text-transform: uppercase; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        
        .table-modern th { text-align: center; font-size: 0.8rem; color: var(--text); padding: 10px 5px; border-bottom: 3px solid var(--border); border-right: 1px solid var(--border); }
        .td-name { background: var(--name-bg); color: var(--text); border-radius: 0px; padding: 12px 18px; min-width: 180px; border: 2px solid var(--border) !important; position: relative; font-size: 0.9rem; }
        .btn-del-row { position: absolute; left: -12px; top: 12px; color: #d32f2f; cursor: pointer; font-size: 1rem; background: white; border-radius: 50%; padding: 2px; }
        
        .slot { width: 40px; height: 40px; border-radius: 8px; background: var(--slot-bg); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 900; cursor: pointer; border: 1px solid var(--border); }
        
        .legend-footer { margin-top: 15px; padding-top: 15px; border-top: 3px solid var(--border); display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; background: var(--card); padding: 6px 10px; border-radius: 8px; border: 2px solid var(--border); color: var(--text); }
        .legend-dot { width: 16px; height: 16px; border-radius: 4px; border: 1px solid #000; }

        .capturing .btn-del-row, .capturing .btn-sm, .capturing .btn-cap-single { display: none !important; }
        .capturing .glass-card { border: 4px solid #000 !important; box-shadow: none !important; margin: 0 !important; }
    </style>
</head>
<body onmouseup="stopPainting()" onmouseleave="stopPainting()">

    <div class="sync-indicator">
        <div class="pulse-dot" id="dot"></div>
        <span id="sync-label" style="color:var(--text)">Sincronizando...</span>
    </div>

    <div id="main-wrapper">
        <div class="sidebar-nav">
            <button class="nav-btn active" onclick="setTab('autenticacao', this)">CP GERAL</button>
            <button class="nav-btn" onclick="setTab('sabado', this)">Sábados</button>
            <button class="nav-btn" onclick="setTab('domingo', this)">Domingos</button>
        </div>

        <div class="paint-palette">
            <div class="d-flex flex-column align-items-center mb-4">
                <div class="mes-badge">
                    <select id="sel-mes" class="mes-select-transparent" onchange="render();"></select>
                    <select id="sel-ano" class="mes-select-transparent" onchange="render();"></select>
                    <span class="ms-3 me-1" style="font-size: 0.75rem; font-weight:900;">FILTRO:</span>
                    <input type="date" id="filtro-inicio" class="mes-select-transparent" onchange="render();">
                    <input type="date" id="filtro-fim" class="mes-select-transparent" onchange="render();">
                    <button class="btn btn-sm btn-light ms-2" onclick="limparFiltro()"><i class="fas fa-times"></i></button>
                </div>
                <div>
                    <button class="btn-box" onclick="changeBox(1)"><i class="fas fa-plus"></i> Adicionar Mês</button>
                    <button class="btn-box bg-danger" onclick="changeBox(-1)"><i class="fas fa-minus"></i> Remover Mês</button>
                    <button class="btn-box bg-success" onclick="save()"><i class="fas fa-save"></i> SALVAR DADOS</button>
                    <button class="btn-box bg-secondary" onclick="toggleTheme()"><i class="fas fa-adjust"></i> TEMA</button>
                </div>
            </div>

            <div class="tools-wrapper">
                <div class="paint-tool st-9H" onclick="selectTool('9H', this)">9H</div>
                <div class="paint-tool st-8H" onclick="selectTool('8H', this)">8H</div>
                <div class="paint-tool st-11H" onclick="selectTool('11H', this)">11H</div>
                <div class="paint-tool st-13H" onclick="selectTool('13H', this)">13H</div>
                <div class="paint-tool st-14H" onclick="selectTool('14H', this)">14H</div>
                <div class="paint-tool st-0-5" onclick="selectTool('0.5', this)">0,5</div>
                <div class="paint-tool st-F" onclick="selectTool('F', this)">F</div>
                <div class="paint-tool st-FER" onclick="selectTool('FER', this)">FER</div>
                <div class="paint-tool st-BH-1" onclick="selectTool('BH-1', this)">BH-1</div>
                <div class="paint-tool st-BH-05" onclick="selectTool('BH-0.5', this)">BH-0.5</div>
                <div class="paint-tool st-FF" onclick="selectTool('FF', this)">FF</div>
                <div class="paint-tool st-FD" onclick="selectTool('FD', this)">FD</div>
                <div class="paint-tool st-FE" onclick="selectTool('FE', this)">FE</div>
                <div class="paint-tool bg-dark ms-2" onclick="selectTool('', this)"><i class="fas fa-eraser"></i></div>
                <button class="btn btn-primary ms-3 rounded-pill fw-900 shadow-sm" style="border: 2px solid #000" onclick="modalNomes.show()">EQUIPE</button>
            </div>
        </div>
        <div id="render-zone"></div>
    </div>

    <div class="modal fade" id="modalNomes" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content glass-card"><div class="modal-body">
        <h5 class="fw-900 text-dark">Gerenciar Equipe</h5>
        <div class="input-group my-3"><input id="inNome" class="form-control border-dark" placeholder="Nome do técnico..."><button class="btn btn-primary" onclick="addN()">ADICIONAR</button></div>
        <div id="listN" class="list-group"></div>
    </div></div></div></div>

    <div class="modal fade" id="modalAdd" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content glass-card"><div class="modal-body">
        <h6 class="fw-900 text-center text-dark">Escalar Funcionário</h6>
        <select id="selT" class="form-select mb-3 border-dark"></select>
        <div id="extra-fields" style="display:none">
            <select id="selS" class="form-select mb-3 border-dark"><option value="1">1ª Semana</option><option value="2">2ª Semana</option><option value="3">3ª Semana</option><option value="4">4ª Semana</option><option value="5">5ª Semana</option></select>
        </div>
        <input type="hidden" id="targetMonth"><input type="hidden" id="targetYear">
        <button class="btn btn-primary w-100 fw-900" onclick="confirmAdd()">CONFIRMAR</button>
    </div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = { k: '$2a$10$Q2kXyLLkTCC5B3yZji9a3.DpwGfIxqoCxivdXlEX95CSREglkI/xG', b: '696fe1e1ae596e708fe97dbb' };
        let db = { escalas: {}, nomesLista: [], config: { boxCount: 1 } };
        let curTab = 'autenticacao', selectedTool = null, isPainting = false;

        const modalNomes = new bootstrap.Modal(document.getElementById('modalNomes'));
        const modalAdd = new bootstrap.Modal(document.getElementById('modalAdd'));
        const meses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
        const mesSel = document.getElementById('sel-mes');
        const anoSel = document.getElementById('sel-ano');
        
        meses.forEach((m, i) => mesSel.innerHTML += `<option value="${i}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`);
        for(let a=2024; a<=2026; a++) anoSel.innerHTML += `<option value="${a}" ${a === new Date().getFullYear() ? 'selected' : ''}>${a}</option>`;

        const legendData = [
            { c: 'st-9H', t: '9H' }, { c: 'st-8H', t: '8H' }, { c: 'st-11H', t: '11H' },
            { c: 'st-13H', t: '13H' }, { c: 'st-14H', t: '14H' }, { c: 'st-0-5', t: '0,5' },
            { c: 'st-F', t: 'F' }, { c: 'st-FER', t: 'FER' }, { c: 'st-BH-1', t: 'BH-1' },
            { c: 'st-BH-05', t: 'BH-0.5' }, { c: 'st-FF', t: 'FF' }, { c: 'st-FD', t: 'FD' }, { c: 'st-FE', t: 'FE' }
        ];

        function getMonthKey(m, a) { return `${m}-${a}`; }
        function getEscala(m, a, tab) { 
            const key = getMonthKey(m, a);
            if(!db.escalas[key]) db.escalas[key] = { autenticacao: [], sabado: [], domingo: [] };
            return db.escalas[key][tab] || [];
        }

        async function save() {
            document.getElementById('sync-label').innerText = "SALVANDO...";
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${API.b}`, {
                    method: 'PUT', headers: { "Content-Type": "application/json", "X-Master-Key": API.k },
                    body: JSON.stringify(db)
                });
                document.getElementById('sync-label').innerText = "SALVO COM SUCESSO!";
            } catch (e) { document.getElementById('sync-label').innerText = "ERRO AO SALVAR!"; }
        }

        async function load() {
            try {
                const r = await fetch(`https://api.jsonbin.io/v3/b/${API.b}/latest`, { headers: { "X-Master-Key": API.k, "X-Bin-Meta": "false" }});
                db = await r.json();
                render();
                document.getElementById('sync-label').innerText = "DADOS ATUALIZADOS";
            } catch (e) { document.getElementById('sync-label').innerText = "OFFLINE"; }
        }

        function render() {
            const area = document.getElementById('render-zone');
            const mB = parseInt(mesSel.value); const aB = parseInt(anoSel.value);
            const fI = document.getElementById('filtro-inicio').value; const fF = document.getElementById('filtro-fim').value;
            let h = "";
            let legendHTML = '<div class="legend-footer">' + legendData.map(l => `<div class="legend-item"><div class="legend-dot ${l.c}"></div><span>${l.t}</span></div>`).join('') + '</div>';
            const count = db.config?.boxCount || 1;

            for(let b=0; b < count; b++) {
                let cM = (mB + b) % 12; let cA = aB + Math.floor((mB + b) / 12);
                let dim = new Date(cA, cM + 1, 0).getDate();
                let boxID = `box-${curTab}-${b}`;
                const items = getEscala(cM, cA, curTab);

                if(curTab === 'autenticacao') {
                    let visibleDays = [];
                    for(let d=1; d<=dim; d++){
                        let dObj = new Date(cA, cM, d); let ok = true;
                        if(fI && dObj < new Date(fI + "T00:00:00")) ok = false;
                        if(fF && dObj > new Date(fF + "T00:00:00")) ok = false;
                        if(ok) visibleDays.push(d);
                    }
                    if (visibleDays.length === 0) continue;

                    let head = `<th class="td-name">TÉCNICO</th>` + visibleDays.map(d => `<th style="background:var(--slot-bg); color:var(--text);">${d}<br>${['DOM','SEG','TER','QUA','QUI','SEX','SAB'][new Date(cA, cM, d).getDay()]}</th>`).join('');
                    let rows = items.map((item, idx) => {
                        let r = `<td class="td-name"><i class="fas fa-trash btn-del-row" onclick="delE(${cM}, ${cA}, ${idx})"></i>${item.nome}</td>`;
                        visibleDays.forEach(d => {
                            let val = item.dias?.[d] || ''; let isFF = val.toString().startsWith('FF:');
                            let disp = isFF ? val.split(':')[1] : val; let cls = isFF ? 'FF' : val.toString().replace('.','-');
                            r += `<td><div class="slot st-${cls||'vazio'}" onmousedown="handleMouseDown(event, ${cM}, ${cA}, ${idx}, ${d})" onmouseenter="moveP(event, ${cM}, ${cA}, ${idx}, ${d})">${disp}</div></td>`;
                        });
                        return `<tr>${r}</tr>`;
                    }).join('');
                    h += `<div class="glass-card" id="${boxID}"><div class="table-title">CP GERAL: ${meses[cM].toUpperCase()} ${cA}
                        <button class="btn btn-sm btn-dark ms-2" onclick="openAdd(${cM}, ${cA})"><i class="fas fa-user-plus"></i></button>
                        <button class="btn btn-sm btn-info ms-2 btn-cap-single" onclick="baixarBox('${boxID}')"><i class="fas fa-camera"></i></button>
                    </div><table class="table-modern"><thead><tr>${head}</tr></thead><tbody>${rows}</tbody></table>${legendHTML}</div>`;
                } else {
                    let weekH = "";
                    for(let s=1; s<=5; s++) {
                        let weekID = `week-${curTab}-${b}-${s}`;
                        weekH += `<tr><td colspan="3" class="p-0"><div id="${weekID}" class="p-2"><div class="d-flex justify-content-center align-items-center gap-2 mb-2" style="color:white; background:var(--accent); border:1px solid #000; padding: 5px;">
                            SEMANA ${s} <button class="btn btn-sm btn-light py-0 btn-cap-single" onclick="baixarBox('${weekID}')"><i class="fas fa-camera" style="font-size:0.7rem"></i></button>
                            </div><table class="table-modern w-100"><tbody>${getRowsWeek(cM, cA, curTab, s)}</tbody></table></div></td></tr>`;
                    }
                    h += `<div class="glass-card" style="min-width:550px"><div class="table-title">${curTab.toUpperCase()}: ${meses[cM].toUpperCase()}
                        <button class="btn btn-sm btn-dark ms-2" onclick="openAdd(${cM}, ${cA})"><i class="fas fa-user-plus"></i></button>
                    </div><table class="table-modern w-100"><thead><tr><th class="td-name">NOME</th><th>DATA</th><th>ST</th></tr></thead><tbody>${weekH}</tbody></table></div>`;
                }
            }
            area.innerHTML = h;
            document.getElementById('listN').innerHTML = (db.nomesLista || []).map((n, i) => `<div class="list-group-item bg-light text-dark border-dark d-flex justify-content-between mb-1"><strong>${n}</strong> <i class="fas fa-trash text-danger" onclick="delN(${i})"></i></div>`).join('');
            document.getElementById('selT').innerHTML = (db.nomesLista || []).map(n => `<option>${n}</option>`).join('');
        }

        function getRowsWeek(m, a, tab, w) {
            const items = getEscala(m, a, tab);
            return items.filter(x => x.semana == w).map(item => {
                const idx = items.indexOf(item); const val = item.dias?.[1] || '';
                return `<tr><td class="td-name"><i class="fas fa-trash btn-del-row" onclick="delE(${m}, ${a}, ${idx})"></i>${item.nome}</td>
                    <td style="border:1px solid var(--border)"><input type="text" class="bg-transparent border-0 text-center fw-900 w-100" style="color:var(--text)" value="${item.dataManual||''}" onchange="db.escalas['${getMonthKey(m,a)}']['${tab}'][${idx}].dataManual=this.value"></td>
                    <td style="border:1px solid var(--border)"><div class="slot st-${val.replace('.','-')||'vazio'} mx-auto" onmousedown="handleMouseDown(event, ${m}, ${a}, ${idx}, 1)">${val}</div></td></tr>`;
            }).join('');
        }

        function toggleTheme() {
            const h = document.documentElement;
            h.setAttribute('data-theme', h.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
            render();
        }

        async function baixarBox(id) {
            const el = document.getElementById(id);
            document.body.classList.add('capturing');
            const canvas = await html2canvas(el, {
                scale: 2,
                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg'),
                logging: false,
                useCORS: true
            });
            const link = document.createElement('a');
            link.download = `Escala_${id}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            document.body.classList.remove('capturing');
        }

        function handleMouseDown(e, m, a, idx, d) { if (e.button === 0) { isPainting = true; paint(m, a, idx, d); } }
        function moveP(e, m, a, idx, d) { if (isPainting && selectedTool !== 'FF') paint(m, a, idx, d); }
        function stopPainting() { isPainting = false; }

        function paint(m, a, idx, d) {
            if(selectedTool === null) return;
            const items = getEscala(m, a, curTab);
            if(!items[idx].dias) items[idx].dias = {};
            let fVal = selectedTool;
            if(selectedTool === 'FF'){ isPainting = false; let n = prompt("Nome do Feriado:"); fVal = n ? "FF:" + n : "FF"; }
            items[idx].dias[d] = fVal; render();
        }

        function openAdd(m, a) { document.getElementById('targetMonth').value = m; document.getElementById('targetYear').value = a; modalAdd.show(); }
        function confirmAdd() {
            const m = document.getElementById('targetMonth').value; const a = document.getElementById('targetYear').value;
            const n = document.getElementById('selT').value; const key = getMonthKey(m, a);
            if(!db.escalas[key]) db.escalas[key] = { autenticacao: [], sabado: [], domingo: [] };
            db.escalas[key][curTab].push({ nome: n, semana: document.getElementById('selS').value, dias: {}, dataManual: "" });
            render(); modalAdd.hide();
        }

        function selectTool(v, el) { selectedTool = v; document.querySelectorAll('.paint-tool').forEach(t => t.classList.remove('active')); if(el) el.classList.add('active'); }
        function setTab(t, b) { curTab = t; document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); document.getElementById('extra-fields').style.display = (t==='sabado'||t==='domingo')?'block':'none'; render(); }
        function changeBox(v) { db.config.boxCount = Math.max(1, (db.config.boxCount||1) + v); render(); }
        function addN() { const i = document.getElementById('inNome'); if(i.value) { db.nomesLista.push(i.value); i.value=''; render(); } }
        function delN(i) { db.nomesLista.splice(i,1); render(); }
        function delE(m, a, idx) { if(confirm("Remover técnico desta escala?")){ db.escalas[getMonthKey(m,a)][curTab].splice(idx,1); render(); } }
        function limparFiltro() { document.getElementById('filtro-inicio').value=''; document.getElementById('filtro-fim').value=''; render(); }

        window.onload = load;
    </script>
</body>
</html>
